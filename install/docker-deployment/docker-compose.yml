version: '3.8'

services:
  nats:
    container_name: credebl-nats
    image: nats
    command: ["-c", "/nats-server.conf"]
    ports:
      - '4222:4222'
      - '6222:6222'
      - '8222:8222'
    volumes:
      - ./nats-server.conf:/nats-server.conf:ro
  redis:
    container_name: credebl-redis
    image: redis:6.2-alpine
    restart: always
    ports:
      - '6381:6379'
    command: redis-server --save 20 1 --loglevel warning
    volumes: 
      - cache:/data
  postgres:
    container_name: credebl-postgres
    image: postgres:16
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=credebl
    volumes:
      - platform-volume:/var/lib/postgresql/data
  seed:
    container_name: seed-service
    image: ghcr.io/credebl/seed:latest
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - ./.env
    volumes:
      - ./credebl-master-table.json:/app/libs/prisma-service/prisma/data/credebl-master-table/credebl-master-table.json
  schema-file-server:
    container_name: schema-file-server
    image: ghcr.io/credebl/schema-file-server:latest
    ports:
      - '4001:4001'
    env_file:
      - ./.env
    volumes:
      - $PWD/apps/schemas:/app/schemas
  api-gateway:
    container_name: api-gateway
    depends_on:
      - nats  # Use depends_on instead of needs
      - redis
      - seed
      - postgres
    image: ghcr.io/credebl/api-gateway:latest
    ports:
      - '5001:5001'
    env_file:
      - ./.env
    volumes:
    - $PWD/apps/uploadedFiles/exports:/app/uploadedFiles/exports
  user:
    container_name: user-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - seed
      - postgres
    image: ghcr.io/credebl/user:latest
    env_file:
      - ./.env
  utility:
    container_name: utility-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - seed
      - postgres
    image: credebl-utility-minio:latest
    env_file:
      - ./.env
  connection:
    container_name: connection-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - utility
      - user
      - seed
      - postgres
    image: ghcr.io/credebl/connection:latest
    env_file:
      - ./.env
  issuance:
    container_name: issuance-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - seed
      - postgres
    image: ghcr.io/credebl/issuance:latest
    env_file:
      - ./.env
    volumes:
    - $PWD/apps/uploadedFiles/exports:/app/uploadedFiles/exports
  ledger:
    container_name: ledger-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - issuance
      - seed
      - postgres
    image: ghcr.io/credebl/ledger:latest
    env_file:
      - ./.env
  organization:
    container_name: organization-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - issuance
      - ledger
      - seed
      - postgres
    image: ghcr.io/credebl/organization:latest
    env_file:
      - ./.env
  verification:
    container_name: verification-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - issuance
      - ledger
      - organization
      - seed
      - postgres
    image: ghcr.io/credebl/verification:latest
    env_file:
      - ./.env
  agent-provisioning:
    container_name: agent-provisioning-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - issuance
      - ledger
      - organization
      - verification
      - seed
      - postgres
    image: ghcr.io/credebl/agent-provisioning:latest
    env_file:
      - ./.env
    environment:
      - ROOT_PATH=$PWD/apps/agent-provisioning/AFJ/agent-config
    volumes:
      - $PWD/apps/agent-provisioning/AFJ/agent-config:/app/agent-provisioning/AFJ/agent-config
      - /var/run/docker.sock:/var/run/docker.sock
      - $PWD/apps/agent-provisioning/AFJ/token:/app/agent-provisioning/AFJ/token
      - $PWD/agent.env:/app/agent.env
  agent-service:
    container_name: agent-service
    depends_on:
      - nats  # Use depends_on instead of needs
      - api-gateway
      - user
      - connection
      - issuance
      - ledger
      - organization
      - verification
      - agent-provisioning
      - seed
      - postgres
    command: >
      sh -c '
        until docker logs agent-provisioning-service | grep "Agent-Provisioning-Service Microservice is listening to NATS"; do sleep 1; done &&
        until docker logs seed-service | grep "The seed command has been executed."; do sleep 1; done &&
        node dist/apps/agent-service/main.js
      '
    image: ghcr.io/credebl/agent-service:latest
    env_file:
      - ./.env
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    volumes_from:
      - agent-provisioning
  cloud-wallet:
    container_name: cloud-wallet-service
    depends_on:
      - nats
      - api-gateway
    image: ghcr.io/credebl/cloud-wallet:latest
    env_file:
      - ./.env
  geolocation:
    container_name: geolocation-service
    depends_on:
      - nats
      - api-gateway
    image: ghcr.io/credebl/geolocation:latest
    env_file:
      - ./.env
  notification:
    container_name: notification-service
    depends_on:
      - nats
      - api-gateway
    image: ghcr.io/credebl/notification:latest
    env_file:
      - ./.env
  webhook:
    container_name: webhook-service
    depends_on:
      - nats
      - api-gateway
    image: ghcr.io/credebl/webhook:latest
    env_file:
      - ./.env
  
# =============================================================================
  # INJI VERIFY STACK (for did:web, did:key, did:jwk verification)
  # =============================================================================

  inji-verify-postgres:
    container_name: inji-verify-postgres
    image: postgres:13
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: inji_verify
    volumes:
      - inji-verify-db:/var/lib/postgresql/data
      - ./patches/inji-verify-official/docker-compose/db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  inji-verify-service:
    container_name: inji-verify-service
    image: mosipid/inji-verify-service:0.16.0
    user: root
    ports:
      - "8082:8080"
    environment:
      - active_profile_env=default
      - DATABASE_HOST=inji-verify-postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=inji_verify
      - DATABASE_SCHEMA=verify
      - DATABASE_USERNAME=postgres
      - DATABASE_PASSWORD=postgres
    depends_on:
      inji-verify-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/verify/actuator/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    restart: unless-stopped

  inji-verify-ui:
    container_name: inji-verify-ui
    image: mosipid/inji-verify-ui:0.16.0
    ports:
      - "3001:8000"
    environment:
      - DEFAULT_TITLE=Inji Verify
      - DEFAULT_LANG=en
      - VERIFIABLE_CLAIMS_CONFIG_URL=/assets/config.json
      - VP_SUBMISSION_SUPPORTED=false
      - DISPLAY_TIMEOUT=120000
    volumes:
      - ./patches/inji-verify-official/docker-compose/config/config.json:/usr/share/nginx/html/assets/config.json:ro
      - ./patches/inji-verify-official/docker-compose/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - inji-verify-service
    links:
      - inji-verify-service:verify-service
    restart: unless-stopped

  # =============================================================================
  # VERIFICATION ADAPTER
  # Routes credentials to appropriate verifier:
  # - did:polygon, did:indy, did:sov, did:peer -> CREDEBL Agent
  # - did:web, did:key, did:jwk -> Inji Verify
  # =============================================================================

  verification-adapter:
    container_name: verification-adapter
    build:
      context: ./patches/polygon-did-fix/adapter
      dockerfile: Dockerfile
    ports:
      - '8085:8085'
      - '8086:8086'  # Context proxy port
    environment:
      - ADAPTER_PORT=8085
      - CONTEXT_PROXY_PORT=8086
      # CREDEBL agent - use env var or default to host gateway
      - CREDEBL_AGENT_URL=${CREDEBL_AGENT_URL:-http://host.docker.internal:8004}
      - CREDEBL_API_KEY=${CREDEBL_API_KEY:-supersecret-that-too-16chars}
      # Inji Verify service - Docker DNS (same network)
      - UPSTREAM_VERIFY_SERVICE=http://inji-verify-service:8080
      # Offline verification settings
      - USE_OFFLINE_ADAPTER=true
      - RUN_CONTEXT_PROXY=true
      # Polygon Mainnet RPC and DID Registry
      - POLYGON_RPC_URL=${POLYGON_RPC_URL:-https://polygon-rpc.com}
      - POLYGON_DID_REGISTRY=${POLYGON_DID_REGISTRY:-0x0C16958c4246271622201101C83B9F0Fc7180d15}
      - CACHE_FILE=/app/cache/issuer-cache.json
      - CACHE_TTL_MS=604800000
      - CONTEXTS_DIR=/app/contexts
    volumes:
      - adapter-cache:/app/cache
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - inji-verify-service
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8085/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped

volumes:
  platform-volume:
  cache:
    driver: local
  inji-verify-db:
  adapter-cache: