%%{init: {'theme': 'base'}}%%

sequenceDiagram
    autonumber
    participant I as Issuer Admin
    participant UI as CREDEBL UI
    participant GW as API Gateway
    participant IS as Issuance Service
    participant AG as Credo Agent
    participant P as Polygon RPC
    participant H as Holder Wallet

    Note over I,H: CREDENTIAL ISSUANCE FLOW

    I->>UI: Create credential offer
    UI->>GW: POST /api/v1/credentials/offer<br/>{schemaId, holderDid, attributes}

    GW->>IS: Route to issuance service
    IS->>IS: Validate request<br/>Check schema exists

    IS->>AG: POST /agent/credential/issue<br/>{credential data}

    AG->>AG: Build W3C credential JSON-LD
    Note over AG: Add @context, type, issuer,<br/>credentialSubject, issuanceDate

    AG->>AG: Sign with private key
    Note over AG: Create EcdsaSecp256k1Signature2019 proof

    AG->>P: Resolve issuer DID (verify key)
    P-->>AG: DID Document

    AG-->>IS: {<br/>  credential: {<br/>    "@context": [...],<br/>    "type": ["VerifiableCredential", ...],<br/>    "issuer": "did:polygon:0x...",<br/>    "credentialSubject": {...},<br/>    "proof": {<br/>      "type": "EcdsaSecp256k1Signature2019",<br/>      "proofValue": "z..."<br/>    }<br/>  }<br/>}

    IS->>IS: Store credential record

    IS-->>GW: Credential response
    GW-->>UI: Credential issued

    UI->>H: Deliver credential<br/>(QR code / deep link / API)

    H->>H: Store credential<br/>Generate QR code

    Note over I,H: Credential ready for verification
